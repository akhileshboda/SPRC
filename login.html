<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kindred â€“ Sign In</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/styles.css">
</head>

<body class="bg-light">

  <div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="card shadow-sm" style="width: 100%; max-width: 420px;">
      <div class="card-body p-4">

        <!-- Branding -->
        <h2 class="card-title text-center mb-1 fw-bold text-primary">Kindred</h2>
        <p class="text-center text-muted mb-4 small">Special Population Resource Connection</p>

        <!-- Inline error alert (hidden until credentials fail) -->
        <div id="loginError" class="alert alert-danger d-none" role="alert"></div>

        <!-- Login form -->
        <form id="loginForm" novalidate>

          <div class="mb-3">
            <label for="email" class="form-label">Email address</label>
            <input type="email" class="form-control" id="email" placeholder="you@example.com" required
              autocomplete="username">
            <div class="invalid-feedback">Please enter a valid email address.</div>
          </div>

          <div class="mb-4">
            <label for="password" class="form-label">Password</label>
            <input type="password" class="form-control" id="password" placeholder="Password" required
              autocomplete="current-password">
            <div class="invalid-feedback">Password is required.</div>
          </div>

          <div class="d-flex flex-column gap-1">
            <button type="submit" class="btn btn-primary w-100">Sign In</button>
            <div class="text-center">
              <p>
                <a href="javascript:void(0)"
                class="link-secondary small"
                onclick="handlePasswordReset()">
                Forgot my password
                </a>
              </p>
            </div>
          </div>

        </form>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/auth.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // If a valid server session already exists, skip the login screen.
      const existingSession = await Auth.getSession();
      if (existingSession) {
        window.location.replace('dashboard.html');
      }
    });

    document.getElementById('loginForm').addEventListener('submit', async function (e) {
      e.preventDefault();

      const form = this;
      form.classList.add('was-validated');

      // Let Bootstrap render field-level validation feedback before checking credentials.
      if (!form.checkValidity()) return;

      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const result = await Auth.login(email, password);

      if (result.success) {
        window.location.replace('dashboard.html');
      } else {
        const errorEl = document.getElementById('loginError');
        errorEl.textContent = result.message;
        errorEl.classList.remove('d-none');
      }
    });

    // Hide the error banner whenever the user starts editing the form again.
    document.getElementById('loginForm').addEventListener('input', function () {
      document.getElementById('loginError').classList.add('d-none');
    });

    function handlePasswordReset() {
      // 1. Prompt for email address
      const email = prompt("Please enter your email address to reset your password:");

      // 2. Simulate validation and sending flow
      if (email === null) {
        return; // User cancelled
      } else if (email.trim() === "") {
        alert("Error: Please enter a valid email address.");
      } else {
        // 3. Confirm simulation
        alert(`Success! A password reset link has been sent to: ${email}\n\nPlease check your inbox.`);
        console.log(`Password reset flow simulated for: ${email}`);
      }
    }

  </script>
</body>

</html>